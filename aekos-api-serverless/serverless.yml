service: aekos-api-serverless

package:
  exclude:
    - secrets.yml

provider:
  name: aws
  runtime: nodejs6.10
  memorySize: 128
  timeout: 15
  vpc:
    securityGroupIds:
      - ${file(secrets.yml):${self:custom.stage}.securityGroupId}
    subnetIds:
      - ${file(secrets.yml):${self:custom.stage}.subnet1Id}
      - ${file(secrets.yml):${self:custom.stage}.subnet2Id}
  environment:
    # FIXME get these encrypted
    DBURL: ${file(secrets.yml):${self:custom.stage}.DBURL}
    DBPORT: ${file(secrets.yml):${self:custom.stage}.DBPORT}
    DBNAME: ${file(secrets.yml):${self:custom.stage}.DBNAME}
    DBUSER: ${file(secrets.yml):${self:custom.stage}.DBUSER}
    DBPASS: ${file(secrets.yml):${self:custom.stage}.DBPASS}

resources:
  Resources:
    MockMethod:
      Type: AWS::ApiGateway::Method
      Properties:
        AuthorizationType: None
        HttpMethod: GET
        ResourceId:
          Fn::GetAtt:
            - ApiGatewayRestApi # our default Rest API logical ID
            - RootResourceId
        RestApiId:
          Ref: ApiGatewayRestApi
        MethodResponses:
          - ResponseModels:
              text/html: Empty
            ResponseParameters:
              method.response.header.Location: true
            StatusCode: 301
        Integration:
          RequestTemplates:
            application/json: |
              {"statusCode": 301}
          Type: MOCK
          IntegrationResponses:
            - ResponseParameters:
                method.response.header.Location: "'${self:custom.documentationUrl}'"
              ResponseTemplates:
                text/html: |
                  <html><body>
                    <p>Redirecting to documentation <a href="${self:custom.documentationUrl}">${self:custom.documentationUrl}</a>
                  </body></html>
              StatusCode: 301

custom:
  stage: ${opt:stage, self:provider.stage}
  secrets: ${file(secrets.yml):$self:custom.stage} # FIXME get this working
  domainName: ${file(secrets.yml):${self:custom.stage}.domainName}
  documentationUrl: https://www.${self:custom.domainName}
  modelDetails: ${file(./model-schemas.yml):exports}
  constants: ${file(./constants.yml)}
  customDomain:
    basePath: '(none)'
    domainName: ${self:custom.domainName}
    stage: ${self:custom.stage}
  commonModelSchemaFragments:
    AcceptHeaderDoco:
      name: accept
      description: "content-type mime that you want as a response e.g.: 'application/json' or 'text/csv'"
    MethodResponse400Json:
      statusCode: 400
      responseModels:
        "application/json": 400JsonResponse
    MethodResponse500Json:
      statusCode: 500
      responseModels:
        "application/json": 500JsonResponse
    StartQueryParam:
      name: ${file(./constants.yml):paramNames.START}
      description: 0-indexed result start index
    RowsQueryParam:
      name: ${file(./constants.yml):paramNames.ROWS}
      description: records per page
    SingleSpeciesNameQueryParam:
      name: ${file(./constants.yml):paramNames.SINGLE_SPECIES_NAME}
      description: single species name to search for
      required: true
    SingleTraitNameQueryParam:
      name: ${file(./constants.yml):paramNames.SINGLE_TRAIT_NAME}
      description: single trait name filter (only values for this trait will be returned)
    SingleVarNameQueryParam:
      name: ${file(./constants.yml):paramNames.SINGLE_VAR_NAME}
      description: single environmental variable name filter (only values for this variable will be returned)
    PageNumQueryParam:
      name: ${file(./constants.yml):paramNames.PAGE_NUM}
      description: 1-indexed page number, default=${self:custom.constants.defaults.PAGE_NUM}
    PageSizeQueryParam:
      name: ${file(./constants.yml):paramNames.PAGE_SIZE}
      description: records per page, default=${self:custom.constants.defaults.PAGE_SIZE}
    DownloadQueryParam:
      name: ${file(./constants.yml):paramNames.DOWNLOAD}
      description: true to trigger a browser download of the result, default=false
  documentation:
    # FIXME doesn't write to the format that AWS expects: {info: {description: "", version: "", title: "", contact: {name: "", email: ""}}}
    api:
      version: 2
      summary: AEKOS API
      # description doesn't work so we add it manually after we pull the Swagger from API Gateway
      #    see: https://github.com/9cookies/serverless-aws-documentation/issues/37
    models:
      -
        name: V1SpeciesSummaryList
        contentType: "application/json"
        schema:
          type: array
          items: ${self:custom.modelDetails.SpeciesSummary}
      -
        name: V1AllSpeciesDataResponse
        contentType: "application/json"
        schema:
          type: object
          properties:
            response: ${self:custom.modelDetails.v1AllSpeciesDataResponse}
            responseHeader: ${self:custom.modelDetails.v1AllSpeciesResponseHeader}
      -
        name: V2AllSpeciesDataResponse
        contentType: "application/json"
        schema:
          type: object
          properties:
            response: ${self:custom.modelDetails.v2AllSpeciesDataResponse}
            responseHeader: ${self:custom.modelDetails.v1AllSpeciesResponseHeader}
      -
        name: V1SpeciesDataResponse
        contentType: "application/json"
        schema:
          type: object
          properties:
            response: ${self:custom.modelDetails.v1AllSpeciesDataResponse}
            responseHeader: ${self:custom.modelDetails.v1SpeciesResponseHeader}
      -
        name: V2SpeciesDataResponse
        contentType: "application/json"
        schema:
          type: object
          properties:
            response: ${self:custom.modelDetails.v2AllSpeciesDataResponse}
            responseHeader: ${self:custom.modelDetails.v1SpeciesResponseHeader}
      -
        name: V1TraitDataJsonResponse
        contentType: "application/json"
        schema:
          type: object
          properties:
            response: ${self:custom.modelDetails.v1TraitResponse}
            responseHeader: ${self:custom.modelDetails.v1TraitResponseHeader}
      -
        name: V1EnvDataResponse
        contentType: "application/json"
        schema:
          type: object
          properties:
            response: ${self:custom.modelDetails.v1EnvResponse}
            responseHeader: ${self:custom.modelDetails.v1EnvResponseHeader}
      -
        name: V2EnvDataResponse
        contentType: "application/json"
        schema:
          type: object
          properties:
            response: ${self:custom.modelDetails.v2EnvResponse}
            responseHeader: ${self:custom.modelDetails.v1EnvResponseHeader}
      -
        name: CsvResponse
        contentType: "text/csv"
        schema:
          type: string
      -
        name: 400JsonResponse
        contentType: "application/json"
        schema:
          type: object
          properties:
            message:
              type: string
      -
        name: 500JsonResponse
        contentType: "application/json"
        schema:
          type: object
          properties:
            message:
              type: string
      -
        name: V1EnvironmentBySpeciesResponse
        contentType: "application/json"
        schema: ${self:custom.modelDetails.fragments.VocabObjectSchema}
      -
        name: V1EnvironmentalVariableVocabResponse
        contentType: "application/json"
        schema: ${file(./v1-getEnvironmentalVariableVocab-json.js):responseSchema}
      -
        name: V1TraitVocabResponse
        contentType: "application/json"
        schema: ${file(./v1-getTraitVocab-json.js):responseSchema}
      -
        name: V1GetEnvironmentBySpeciesRequest
        contentType: "application/json"
        schema: ${self:custom.modelDetails.fragments.SpeciesNamesPostRequest}
      -
        name: V1SpeciesSummaryRequest
        contentType: "application/json"
        schema: ${self:custom.modelDetails.fragments.SpeciesNamesPostRequest}
      -
        name: V1SpeciesAutocompleteResponse
        contentType: "application/json"
        schema:
          type: array
          items:
            type: object
            properties:
              speciesName:
                type: string
              recordsHeld:
                type: string
              id:
                type: string
plugins:
  - serverless-aws-documentation
  - serverless-domain-manager

functions:
  v1-getEnvironmentBySpecies-json:
    handler: v1-getEnvironmentBySpecies-json.handler
    events:
      - http:
          path: v1/getEnvironmentBySpecies.json
          method: post
          cors: true
          documentation:
            summary: Get all available environment variable names for specified species
            description: >
              Finds the environmental variables that the supplied species have. Note that the result doesn't
              include the value of the environmental variables, it only shows that the supplied species have
              values for those variable. To get the values, you need to use the Data Retrieval services.
            queryParams:
              - ${self:custom.commonModelSchemaFragments.PageNumQueryParam}
              - ${self:custom.commonModelSchemaFragments.PageSizeQueryParam}
            requestModels:
               "application/json": V1GetEnvironmentBySpeciesRequest
            methodResponses:
              -
                statusCode: 200
                responseModels:
                  "application/json": V1EnvironmentBySpeciesResponse
              - ${self:custom.commonModelSchemaFragments.MethodResponse400Json}
              - ${self:custom.commonModelSchemaFragments.MethodResponse500Json}
  v1-getTraitsBySpecies-json:
    handler: v1-getTraitsBySpecies-json.handler
    events:
      - http:
          path: v1/getTraitsBySpecies.json
          method: get
          cors: true
          documentation:
            summary: Get all available traits for specified species
            description: >
              Finds the traits that the supplied species have. Note that the result doesn't include the value
              of the traits, it only shows that the supplied species have values for those traits. To get
              the values, you need to use the Data Retrieval services.
            queryParams:
              - ${self:custom.commonModelSchemaFragments.SingleSpeciesNameQueryParam}
              - ${self:custom.commonModelSchemaFragments.PageNumQueryParam}
              - ${self:custom.commonModelSchemaFragments.PageSizeQueryParam}
  v1-getSpeciesByTrait-json:
    handler: v1-getSpeciesByTrait-json.handler
    events:
      - http:
          path: v1/getSpeciesByTrait.json
          method: get
          cors: true
          documentation:
            summary: Get all available species for specified traits
            description: >
              Finds the species names that the supplied trait(s). Note that the result only shows that the supplied
              traits have species records present in the system. To get the values, you need to use the Data
              Retrieval services.
            queryParams:
              -
                name: ${file(./constants.yml):paramNames.SINGLE_TRAIT_NAME}
                description: single trait name to search for
                required: true
              - ${self:custom.commonModelSchemaFragments.PageNumQueryParam}
              - ${self:custom.commonModelSchemaFragments.PageSizeQueryParam}
            methodResponses:
              - ${self:custom.commonModelSchemaFragments.MethodResponse400Json}
              - ${self:custom.commonModelSchemaFragments.MethodResponse500Json}
  v1-getTraitVocab-json:
    handler: v1-getTraitVocab-json.handler
    events:
      - http:
          path: v1/getTraitVocab.json
          method: get
          cors: true
          documentation:
            summary: Get trait vocabulary
            description: >
              Gets a distinct list of all the traits that appear in the system. The code and label are supplied for
              each trait. The codes are required to use as parameters for other resources and the label information
              is useful for creating UIs.
            methodResponses:
              -
                statusCode: 200
                responseModels:
                  "application/json": V1TraitVocabResponse
              - ${self:custom.commonModelSchemaFragments.MethodResponse500Json}
  v1-getEnvironmentalVariableVocab-json:
    handler: v1-getEnvironmentalVariableVocab-json.handler
    events:
      - http:
          path: v1/getEnvironmentalVariableVocab.json
          method: get
          cors: true
          documentation:
            summary: Get environmental variable vocabulary
            description: >
              Gets a distinct list of all the environmental variables that appear in the system. The code and label are supplied for
              each trait. The codes are required to use as parameters for other resources and the label information
              is useful for creating UIs.
            methodResponses:
              -
                statusCode: 200
                responseModels:
                  "application/json": V1EnvironmentalVariableVocabResponse
              - ${self:custom.commonModelSchemaFragments.MethodResponse500Json}
  v1-speciesAutocomplete-json:
    handler: v1-speciesAutocomplete-json.handler
    events:
      - http:
          path: v1/speciesAutocomplete.json
          method: get
          cors: true
          documentation:
            summary: Autocomplete partial species names
            description: >
              Performs an autocomplete on the partial species name supplied. Results starting with the supplied
              fragment will be returned ordered by most relevant.
            queryParams:
              -
                name: ${self:custom.constants.paramNames.PARTIAL_NAME}
                description: partial species name
                required: true
              -
                name: ${self:custom.constants.paramNames.OFFSET}
                description: 0-indexed offset, default=${self:custom.constants.defaults.OFFSET}
              -
                name: ${self:custom.constants.paramNames.PAGE_SIZE}
                description: number of records per page, default=${self:custom.constants.defaults.PAGE_SIZE}
            methodResponses:
              -
                statusCode: 200
                responseModels:
                  "application/json": V1SpeciesAutocompleteResponse
              - ${self:custom.commonModelSchemaFragments.MethodResponse400Json}
              - ${self:custom.commonModelSchemaFragments.MethodResponse500Json}
  v1-speciesSummary-json:
    handler: v1-speciesSummary-json.handler
    events:
      - http:
          path: v1/speciesSummary.json
          method: post
          cors: true
          documentation:
            summary: Get a summary of the specified species names
            description: >
              A summary of the information that the system holds on the supplied species name(s) including a count
              of records. If the system doesn't have any data on a species name, no record for the species name will
              be in the result.
            requestModels:
               "application/json": V1SpeciesSummaryRequest
            methodResponses:
              -
                statusCode: 200
                responseModels:
                  "application/json": V1SpeciesSummaryList
              - ${self:custom.commonModelSchemaFragments.MethodResponse400Json}
              - ${self:custom.commonModelSchemaFragments.MethodResponse500Json}
  speciesData:
    handler: speciesData.handler
    events:
      - http:
          path: v1/speciesData
          method: get
          cors: true
          documentation:
            summary: Get species data
            description: >
              Gets Darwin Core records for the supplied species name(s) using content negotation to determine the response type.
              This resource honours Accept headers represented by any of the /v1/speciesData.* resources.
            queryParams:
              - ${self:custom.commonModelSchemaFragments.SingleSpeciesNameQueryParam}
              - ${self:custom.commonModelSchemaFragments.StartQueryParam}
              - ${self:custom.commonModelSchemaFragments.RowsQueryParam}
            methodResponses:
              -
                statusCode: 200
                responseModels:
                  "text/csv": CsvResponse
                  "application/json": V1SpeciesDataResponse
              - ${self:custom.commonModelSchemaFragments.MethodResponse400Json}
              - ${self:custom.commonModelSchemaFragments.MethodResponse500Json}
      - http:
          path: v2/speciesData
          method: get
          cors: true
          documentation:
            summary: Get species data
            description: >
              Gets Darwin Core records for the supplied species name(s) using content negotation to determine the response type.
              This resource honours Accept headers represented by any of the /v2/speciesData.* resources.
              ${file(./constants.yml):messages.documentation.v2NewFields}
            queryParams:
              - ${self:custom.commonModelSchemaFragments.SingleSpeciesNameQueryParam}
              - ${self:custom.commonModelSchemaFragments.StartQueryParam}
              - ${self:custom.commonModelSchemaFragments.RowsQueryParam}
            methodResponses:
              -
                statusCode: 200
                responseModels:
                  "text/csv": CsvResponse
                  "application/json": V2SpeciesDataResponse
              - ${self:custom.commonModelSchemaFragments.MethodResponse400Json}
              - ${self:custom.commonModelSchemaFragments.MethodResponse500Json}
  speciesData-json:
    handler: speciesData-json.handler
    events:
      - http:
          path: v1/speciesData.json
          method: get
          cors: true
          documentation:
            summary: Get species data in JSON format
            description: >
              Gets Darwin Core records for the supplied species name(s) in JSON format.
            queryParams:
              - ${self:custom.commonModelSchemaFragments.SingleSpeciesNameQueryParam}
              - ${self:custom.commonModelSchemaFragments.StartQueryParam}
              - ${self:custom.commonModelSchemaFragments.RowsQueryParam}
            methodResponses:
              -
                statusCode: 200
                responseModels:
                  "application/json": V1SpeciesDataResponse
              - ${self:custom.commonModelSchemaFragments.MethodResponse400Json}
              - ${self:custom.commonModelSchemaFragments.MethodResponse500Json}
      - http:
          path: v2/speciesData.json
          method: get
          cors: true
          documentation:
            summary: Get species data in JSON format
            description: >
              Gets Darwin Core records for the supplied species name(s) in JSON format.
              ${file(./constants.yml):messages.documentation.v2NewFields}
            queryParams:
              - ${self:custom.commonModelSchemaFragments.SingleSpeciesNameQueryParam}
              - ${self:custom.commonModelSchemaFragments.StartQueryParam}
              - ${self:custom.commonModelSchemaFragments.RowsQueryParam}
            methodResponses:
              -
                statusCode: 200
                responseModels:
                  "application/json": V2SpeciesDataResponse
              - ${self:custom.commonModelSchemaFragments.MethodResponse400Json}
              - ${self:custom.commonModelSchemaFragments.MethodResponse500Json}
  speciesData-csv:
    handler: speciesData-csv.handler
    events:
      - http:
          path: v1/speciesData.csv
          method: get
          cors: true
          documentation:
            summary: Get species data in CSV format
            description: >
              Gets Darwin Core records for the supplied species name(s) in CSV format.
            queryParams:
              - ${self:custom.commonModelSchemaFragments.SingleSpeciesNameQueryParam}
              - ${self:custom.commonModelSchemaFragments.StartQueryParam}
              - ${self:custom.commonModelSchemaFragments.RowsQueryParam}
            methodResponses:
              -
                statusCode: 200
                responseModels:
                  "text/csv": CsvResponse
              - ${self:custom.commonModelSchemaFragments.MethodResponse400Json}
              - ${self:custom.commonModelSchemaFragments.MethodResponse500Json}
      - http:
          path: v2/speciesData.csv
          method: get
          cors: true
          documentation:
            summary: Get species data in CSV format
            description: >
              Gets Darwin Core records for the supplied species name(s) in CSV format.
            queryParams:
              - ${self:custom.commonModelSchemaFragments.SingleSpeciesNameQueryParam}
              - ${self:custom.commonModelSchemaFragments.StartQueryParam}
              - ${self:custom.commonModelSchemaFragments.RowsQueryParam}
            methodResponses:
              -
                statusCode: 200
                responseModels:
                  "text/csv": CsvResponse
              - ${self:custom.commonModelSchemaFragments.MethodResponse400Json}
              - ${self:custom.commonModelSchemaFragments.MethodResponse500Json}
  v1-traitData:
    handler: v1-traitData.handler
    events:
      - http:
          path: v1/traitData
          method: get
          cors: true
          documentation:
            summary: Get trait data
            description: >
              Gets Darwin Core records with added trait information for the supplied species name(s) using content negotation to
              determine the response type. If you supply trait names then the result records will have the traits filtered down
              to only the traits you've asked for, otherwise all traits are returned. This resource honours Accept headers
              represented by any of the /v1/traitData.* resources.
            queryParams:
              - ${self:custom.commonModelSchemaFragments.SingleSpeciesNameQueryParam}
              - ${self:custom.commonModelSchemaFragments.SingleTraitNameQueryParam}
              - ${self:custom.commonModelSchemaFragments.StartQueryParam}
              - ${self:custom.commonModelSchemaFragments.RowsQueryParam}
            requestHeaders:
               # TODO not sure if it's worth putting this here, the Swagger UI already has an input for it
              - ${self:custom.commonModelSchemaFragments.AcceptHeaderDoco}
            methodResponses:
              -
                statusCode: 200
                responseModels:
                  "text/csv": CsvResponse
                  "application/json": V1TraitDataJsonResponse
              - ${self:custom.commonModelSchemaFragments.MethodResponse400Json}
              - ${self:custom.commonModelSchemaFragments.MethodResponse500Json}
  v1-traitData-json:
    handler: v1-traitData-json.handler
    events:
      - http:
          path: v1/traitData.json
          method: get
          cors: true
          documentation:
            summary: Get trait data in JSON format
            description: >
              Gets Darwin Core records with added trait information in JSON format. If you supply trait names then the result
              records will have the traits filtered down to only the traits you've asked for, otherwise all traits are returned.
            queryParams:
              - ${self:custom.commonModelSchemaFragments.SingleSpeciesNameQueryParam}
              - ${self:custom.commonModelSchemaFragments.SingleTraitNameQueryParam}
              - ${self:custom.commonModelSchemaFragments.StartQueryParam}
              - ${self:custom.commonModelSchemaFragments.RowsQueryParam}
            methodResponses:
              -
                statusCode: 200
                responseModels:
                  "application/json": V1TraitDataJsonResponse
              - ${self:custom.commonModelSchemaFragments.MethodResponse400Json}
              - ${self:custom.commonModelSchemaFragments.MethodResponse500Json}
  v1-traitData-csv:
    handler: v1-traitData-csv.handler
    events:
      - http:
          path: v1/traitData.csv
          method: get
          cors: true
          documentation:
            summary: Get trait data in CSV format
            description: >
              Gets Darwin Core records with added trait information in CSV format. If you supply trait names then the result
              records will have the traits filtered down to only the traits you've asked for, otherwise all traits are returned.
            queryParams:
              - ${self:custom.commonModelSchemaFragments.SingleSpeciesNameQueryParam}
              - ${self:custom.commonModelSchemaFragments.SingleTraitNameQueryParam}
              - ${self:custom.commonModelSchemaFragments.StartQueryParam}
              - ${self:custom.commonModelSchemaFragments.RowsQueryParam}
            methodResponses:
              -
                statusCode: 200
                responseModels:
                  "text/csv": CsvResponse
              - ${self:custom.commonModelSchemaFragments.MethodResponse400Json}
              - ${self:custom.commonModelSchemaFragments.MethodResponse500Json}
  v1-environmentData:
    handler: v1-environmentData.handler
    events:
      - http:
          path: v1/environmentData
          method: get
          cors: true
          documentation:
            summary: Get environmental variable data
            description: >
              Gets environmental variable data records for the site/study location/plot visits that the supplied species name(s)
              appear at using content negotation to determine the response type. If you supply environmental variable names then
              the result will have the environmental variables filtered down to only the environmental variables you've asked for,
              otherwise all environmental variables are returned. Note: not all sites have environmental variables available.
              This resource honours Accept headers represented by any of the /v1/environmentData.* resources.
            queryParams:
              - ${self:custom.commonModelSchemaFragments.SingleSpeciesNameQueryParam}
              - ${self:custom.commonModelSchemaFragments.SingleVarNameQueryParam}
              - ${self:custom.commonModelSchemaFragments.StartQueryParam}
              - ${self:custom.commonModelSchemaFragments.RowsQueryParam}
            methodResponses:
              -
                statusCode: 200
                responseModels:
                  "text/csv": CsvResponse
                  "application/json": V1EnvDataResponse
              - ${self:custom.commonModelSchemaFragments.MethodResponse400Json}
              - ${self:custom.commonModelSchemaFragments.MethodResponse500Json}
  v2-environmentData:
    handler: v2-environmentData.handler
    events:
      - http:
          path: v2/environmentData
          method: get
          cors: true
          documentation:
            summary: Get environmental variable data
            description: >
              Gets environmental variable data records for the site/study location/plot visits that the supplied species name(s)
              appear at using content negotation to determine the response type. If you supply environmental variable names then
              the result will have the environmental variables filtered down to only the environmental variables you've asked for,
              otherwise all environmental variables are returned. Note: not all sites have environmental variables available.
              This resource honours Accept headers represented by any of the /v2/environmentData.* resources.
              ${file(./constants.yml):messages.documentation.v2NewFields}
            queryParams:
              - ${self:custom.commonModelSchemaFragments.SingleSpeciesNameQueryParam}
              - ${self:custom.commonModelSchemaFragments.SingleVarNameQueryParam}
              - ${self:custom.commonModelSchemaFragments.StartQueryParam}
              - ${self:custom.commonModelSchemaFragments.RowsQueryParam}
            methodResponses:
              -
                statusCode: 200
                responseModels:
                  "text/csv": CsvResponse
                  "application/json": V2EnvDataResponse
              - ${self:custom.commonModelSchemaFragments.MethodResponse400Json}
              - ${self:custom.commonModelSchemaFragments.MethodResponse500Json}
  v1-environmentData-json:
    handler: v1-environmentData-json.handler
    events:
      - http:
          path: v1/environmentData.json
          method: get
          cors: true
          documentation:
            summary: Get environmental variable data in JSON format
            description: >
              Gets environmental variable data records for the site/study location/plot visits that the supplied species name(s)
              appear at in JSON format. If you supply environmental variable names then the result will have the environmental
              variables filtered down to only the environmental variables you've asked for, otherwise all environmental
              variables are returned. Note: not all sites have environmental variables available.
            queryParams:
              - ${self:custom.commonModelSchemaFragments.SingleSpeciesNameQueryParam}
              - ${self:custom.commonModelSchemaFragments.SingleVarNameQueryParam}
              - ${self:custom.commonModelSchemaFragments.StartQueryParam}
              - ${self:custom.commonModelSchemaFragments.RowsQueryParam}
            methodResponses:
              -
                statusCode: 200
                responseModels:
                  "application/json": V1EnvDataResponse
              - ${self:custom.commonModelSchemaFragments.MethodResponse400Json}
              - ${self:custom.commonModelSchemaFragments.MethodResponse500Json}
  v2-environmentData-json:
    handler: v2-environmentData-json.handler
    events:
      - http:
          path: v2/environmentData.json
          method: get
          cors: true
          documentation:
            summary: Get environmental variable data in JSON format
            description: >
              Gets environmental variable data records for the site/study location/plot visits that the supplied species name(s)
              appear at in JSON format. If you supply environmental variable names then the result will have the environmental
              variables filtered down to only the environmental variables you've asked for, otherwise all environmental
              variables are returned. Note: not all sites have environmental variables available.
              ${file(./constants.yml):messages.documentation.v2NewFields}
            queryParams:
              - ${self:custom.commonModelSchemaFragments.SingleSpeciesNameQueryParam}
              - ${self:custom.commonModelSchemaFragments.SingleVarNameQueryParam}
              - ${self:custom.commonModelSchemaFragments.StartQueryParam}
              - ${self:custom.commonModelSchemaFragments.RowsQueryParam}
            methodResponses:
              -
                statusCode: 200
                responseModels:
                  "application/json": V2EnvDataResponse
              - ${self:custom.commonModelSchemaFragments.MethodResponse400Json}
              - ${self:custom.commonModelSchemaFragments.MethodResponse500Json}
  v1-environmentData-csv:
    handler: v1-environmentData-csv.handler
    events:
      - http:
          path: v1/environmentData.csv
          method: get
          cors: true
          documentation:
            summary: Get environmental variable data in CSV format
            description: >
              Gets environmental variable data records for the site/study location/plot visits that the supplied species name(s)
              appear at in CSV format. If you supply environmental variable names then the result will have the environmental
              variables filtered down to only the environmental variables you've asked for, otherwise all environmental
              variables are returned. Note: not all sites have environmental variables available.
            queryParams:
              - ${self:custom.commonModelSchemaFragments.SingleSpeciesNameQueryParam}
              - ${self:custom.commonModelSchemaFragments.SingleVarNameQueryParam}
              - ${self:custom.commonModelSchemaFragments.StartQueryParam}
              - ${self:custom.commonModelSchemaFragments.RowsQueryParam}
            methodResponses:
              -
                statusCode: 200
                responseModels:
                  "text/csv": CsvResponse
              - ${self:custom.commonModelSchemaFragments.MethodResponse400Json}
              - ${self:custom.commonModelSchemaFragments.MethodResponse500Json}
  v2-environmentData-csv:
    handler: v2-environmentData-csv.handler
    events:
      - http:
          path: v2/environmentData.csv
          method: get
          cors: true
          documentation:
            summary: Get environmental variable data in CSV format
            description: >
              Gets environmental variable data records for the site/study location/plot visits that the supplied species name(s)
              appear at in CSV format. If you supply environmental variable names then the result will have the environmental
              variables filtered down to only the environmental variables you've asked for, otherwise all environmental
              variables are returned. Note: not all sites have environmental variables available.
              ${file(./constants.yml):messages.documentation.v2NewFields}
            queryParams:
              - ${self:custom.commonModelSchemaFragments.SingleSpeciesNameQueryParam}
              - ${self:custom.commonModelSchemaFragments.SingleVarNameQueryParam}
              - ${self:custom.commonModelSchemaFragments.StartQueryParam}
              - ${self:custom.commonModelSchemaFragments.RowsQueryParam}
            methodResponses:
              -
                statusCode: 200
                responseModels:
                  "text/csv": CsvResponse
              - ${self:custom.commonModelSchemaFragments.MethodResponse400Json}
              - ${self:custom.commonModelSchemaFragments.MethodResponse500Json}
  allSpeciesData:
    handler: allSpeciesData.handler
    timeout: 40
    events:
      - http:
          path: v1/allSpeciesData
          method: get
          cors: true
          documentation:
            summary: Get all species data
            description: >
              Gets all Darwin Core records using content negotation to determine the response type. This resource honours Accept
              headers represented by any of the /v1/allSpeciesData.* resources.
            queryParams:
              - ${self:custom.commonModelSchemaFragments.StartQueryParam}
              - ${self:custom.commonModelSchemaFragments.RowsQueryParam}
            methodResponses:
              -
                statusCode: 200
                responseModels:
                  "text/csv": CsvResponse
                  "application/json": V1AllSpeciesDataResponse
              - ${self:custom.commonModelSchemaFragments.MethodResponse400Json}
              - ${self:custom.commonModelSchemaFragments.MethodResponse500Json}
      - http:
          path: v2/allSpeciesData
          method: get
          cors: true
          documentation:
            summary: Get all species data
            description: >
              Gets all Darwin Core records using content negotation to determine the response type. This resource honours Accept
              headers represented by any of the /v2/allSpeciesData.* resources. ${file(./constants.yml):messages.documentation.v2NewFields}
            queryParams:
              - ${self:custom.commonModelSchemaFragments.StartQueryParam}
              - ${self:custom.commonModelSchemaFragments.RowsQueryParam}
            methodResponses:
              -
                statusCode: 200
                responseModels:
                  "text/csv": CsvResponse
                  "application/json": V2AllSpeciesDataResponse
              - ${self:custom.commonModelSchemaFragments.MethodResponse400Json}
              - ${self:custom.commonModelSchemaFragments.MethodResponse500Json}
  allSpeciesData-json:
    handler: allSpeciesData-json.handler
    timeout: 40
    events:
      - http:
          path: v1/allSpeciesData.json
          method: get
          cors: true
          documentation:
            summary: Get all species data in JSON format
            description: >
              Gets Darwin Core records in JSON format.
            queryParams:
              - ${self:custom.commonModelSchemaFragments.StartQueryParam}
              - ${self:custom.commonModelSchemaFragments.RowsQueryParam}
            methodResponses:
              -
                statusCode: 200
                responseModels:
                  "application/json": V1AllSpeciesDataResponse
              - ${self:custom.commonModelSchemaFragments.MethodResponse400Json}
              - ${self:custom.commonModelSchemaFragments.MethodResponse500Json}
      - http:
          path: v2/allSpeciesData.json
          method: get
          cors: true
          documentation:
            summary: Get all species data in JSON format
            description: >
              Gets Darwin Core records in JSON format. ${file(./constants.yml):messages.documentation.v2NewFields}
            queryParams:
              - ${self:custom.commonModelSchemaFragments.StartQueryParam}
              - ${self:custom.commonModelSchemaFragments.RowsQueryParam}
            methodResponses:
              -
                statusCode: 200
                responseModels:
                  "application/json": V2AllSpeciesDataResponse
              - ${self:custom.commonModelSchemaFragments.MethodResponse400Json}
              - ${self:custom.commonModelSchemaFragments.MethodResponse500Json}
  allSpeciesData-csv:
    handler: allSpeciesData-csv.handler
    timeout: 40
    events:
      - http:
          path: v1/allSpeciesData.csv
          method: get
          cors: true
          documentation:
            summary: Get all species occurrence data in CSV format
            description: >
              Gets all Darwin Core records in CSV format.
            queryParams:
              - ${self:custom.commonModelSchemaFragments.StartQueryParam}
              - ${self:custom.commonModelSchemaFragments.RowsQueryParam}
              - ${self:custom.commonModelSchemaFragments.DownloadQueryParam}
            methodResponses:
              -
                statusCode: 200
                responseModels:
                  "text/csv": CsvResponse
              - ${self:custom.commonModelSchemaFragments.MethodResponse400Json}
              - ${self:custom.commonModelSchemaFragments.MethodResponse500Json}
      - http:
          path: v2/allSpeciesData.csv
          method: get
          cors: true
          documentation:
            summary: Get all species occurrence data in CSV format
            description: >
              Gets all Darwin Core records in CSV format. ${file(./constants.yml):messages.documentation.v2NewFields}
            queryParams:
              - ${self:custom.commonModelSchemaFragments.StartQueryParam}
              - ${self:custom.commonModelSchemaFragments.RowsQueryParam}
              - ${self:custom.commonModelSchemaFragments.DownloadQueryParam}
            methodResponses:
              -
                statusCode: 200
                responseModels:
                  "text/csv": CsvResponse
              - ${self:custom.commonModelSchemaFragments.MethodResponse400Json}
              - ${self:custom.commonModelSchemaFragments.MethodResponse500Json}
